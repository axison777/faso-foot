# Guide d'impl√©mentation - Gestion de Club Manager

## üìã Vue d'ensemble

Ce guide explique comment utiliser les APIs pour la gestion des clubs par un responsable de club. Le syst√®me permet au responsable de g√©rer toutes les √©quipes de son club et le staff associ√© √† chaque √©quipe.

## üîë Authentification et Identification

### R√©ponse de connexion du backend

Lors de la connexion, le responsable de club re√ßoit ces informations :

```json
{
  "id": "ebd9dc38-b447-42d1-8efa-822ce6167ead",
  "last_name": "Mansa",
  "first_name": "Moussa",
  "email": "rfa.responsable@gmail.com",
  "is_active": true,
  "is_club_manager": true,
  "is_coach": false,
  "is_official": false,
  "club_id": "a3e79a21-22e5-4e6c-b775-f6340f211d71",
  "coach_id": null,
  "official_id": null,
  "team_id": null,
  "roles": []
}
```

**Points importants :**
- `is_club_manager: true` ‚Üí Identifie l'utilisateur comme responsable de club
- `club_id` ‚Üí ID du club √† g√©rer
- Pas de `team_id` car il g√®re plusieurs √©quipes

## üìÅ Structure des fichiers cr√©√©s

### 1. Mod√®les (`/src/app/models/club-manager-api.model.ts`)

Contient toutes les interfaces TypeScript pour :
- `ClubManagerClub` : Informations du club
- `ClubManagerTeam` : Informations d'une √©quipe
- `ClubManagerPlayer` : Informations d'un joueur
- `ClubManagerStaffMember` : Informations d'un membre du staff
- `ClubManagerMatch` : Informations d'un match
- Plus les interfaces pour les r√©ponses API et les filtres

### 2. Service (`/src/app/service/club-manager.service.ts`)

Service centralis√© pour tous les appels API avec les m√©thodes suivantes :

#### M√©thodes Club
- `getClubById(clubId)` : R√©cup√®re les infos du club avec ses √©quipes
- `getClubTeams(clubId)` : R√©cup√®re uniquement les √©quipes

#### M√©thodes Team
- `getTeamById(teamId)` : R√©cup√®re les infos d'une √©quipe
- `getTeamWithAllData(teamId)` : R√©cup√®re toutes les donn√©es (joueurs, staff, matchs)

#### M√©thodes Players
- `getTeamPlayers(teamId)` : R√©cup√®re les joueurs d'une √©quipe
- `getPlayerDetails(playerId)` : R√©cup√®re les d√©tails d'un joueur
- `getAllClubPlayers(clubId)` : R√©cup√®re tous les joueurs du club

#### M√©thodes Staff
- `getTeamStaff(teamId)` : R√©cup√®re le staff d'une √©quipe
- `getAllClubStaff(clubId)` : R√©cup√®re tout le staff du club

#### M√©thodes Matches
- `getTeamMatchesPaginated(teamId, filters?)` : R√©cup√®re les matchs (pagin√©)
- `getTeamMatches(teamId, filters?)` : R√©cup√®re les matchs (simple)
- `getUpcomingMatches(teamId)` : R√©cup√®re les matchs √† venir
- `getPastMatches(teamId)` : R√©cup√®re les matchs pass√©s
- `getNextMatch(teamId)` : R√©cup√®re le prochain match
- `getAllClubMatches(clubId, filters?)` : R√©cup√®re tous les matchs du club

#### M√©thodes utilitaires
- `enrichMatches()` : Enrichit les matchs avec des donn√©es calcul√©es
- `filterMatchesByPeriod()` : Filtre par p√©riode
- `sortMatches()` : Trie les matchs
- `calculatePlayerAge()` : Calcule l'√¢ge d'un joueur
- `determineContractStatus()` : D√©termine le statut du contrat

### 3. Composant exemple (`/src/app/pages/club-manager-dashboard/`)

Composant dashboard qui montre comment utiliser le service.

## üöÄ Utilisation du service

### Exemple 1 : Charger les donn√©es du club

```typescript
import { Component, OnInit, inject } from '@angular/core';
import { ClubManagerService } from '../../service/club-manager.service';
import { AuthService } from '../../service/auth.service';

@Component({
  selector: 'app-my-component',
  standalone: true,
  // ...
})
export class MyComponent implements OnInit {
  private clubManagerService = inject(ClubManagerService);
  private authService = inject(AuthService);

  ngOnInit() {
    const user = this.authService.currentUser;
    
    if (user?.club_id) {
      // Charger le club avec toutes ses √©quipes
      this.clubManagerService.getClubById(user.club_id).subscribe({
        next: (club) => {
          console.log('Club charg√©:', club);
          console.log('√âquipes:', club.teams);
        },
        error: (err) => {
          console.error('Erreur:', err);
        }
      });
    }
  }
}
```

### Exemple 2 : Charger les donn√©es d'une √©quipe

```typescript
// M√©thode 1 : Charger uniquement les infos de base
this.clubManagerService.getTeamById(teamId).subscribe(team => {
  console.log('√âquipe:', team);
});

// M√©thode 2 : Charger toutes les donn√©es en parall√®le (recommand√©)
this.clubManagerService.getTeamWithAllData(teamId).subscribe(teamData => {
  console.log('√âquipe:', teamData);
  console.log('Joueurs:', teamData.players);
  console.log('Staff:', teamData.staff);
  console.log('Matchs √† venir:', teamData.upcomingMatches);
  console.log('Matchs pass√©s:', teamData.pastMatches);
});
```

### Exemple 3 : G√©rer les joueurs

```typescript
// R√©cup√©rer les joueurs d'une √©quipe
this.clubManagerService.getTeamPlayers(teamId).subscribe(players => {
  console.log('Joueurs de l\'√©quipe:', players);
});

// R√©cup√©rer tous les joueurs du club
this.clubManagerService.getAllClubPlayers(clubId).subscribe(players => {
  console.log('Tous les joueurs du club:', players);
});

// R√©cup√©rer les d√©tails d'un joueur
this.clubManagerService.getPlayerDetails(playerId).subscribe(player => {
  console.log('D√©tails du joueur:', player);
  
  // Calculer son √¢ge
  const age = this.clubManagerService.calculatePlayerAge(player.date_of_birth);
  console.log('√Çge:', age);
  
  // V√©rifier le statut du contrat
  const status = this.clubManagerService.determineContractStatus(player.contract_end_date);
  console.log('Statut contrat:', status); // 'VALID', 'EXPIRING', ou 'EXPIRED'
});
```

### Exemple 4 : G√©rer le staff

```typescript
// R√©cup√©rer le staff d'une √©quipe
this.clubManagerService.getTeamStaff(teamId).subscribe(staff => {
  console.log('Staff de l\'√©quipe:', staff);
});

// R√©cup√©rer tout le staff du club
this.clubManagerService.getAllClubStaff(clubId).subscribe(staff => {
  console.log('Tout le staff du club:', staff);
});
```

### Exemple 5 : G√©rer les matchs

```typescript
// R√©cup√©rer les matchs avec pagination
this.clubManagerService.getTeamMatchesPaginated(teamId, {
  per_page: 20,
  page: 1,
  status: 'planned'
}).subscribe(response => {
  console.log('Matchs:', response.data);
  console.log('Pagination:', response.meta);
  console.log('Liens:', response.links);
});

// R√©cup√©rer les matchs √† venir
this.clubManagerService.getUpcomingMatches(teamId).subscribe(matches => {
  console.log('Matchs √† venir:', matches);
});

// R√©cup√©rer les matchs pass√©s
this.clubManagerService.getPastMatches(teamId).subscribe(matches => {
  console.log('Matchs pass√©s:', matches);
});

// R√©cup√©rer le prochain match
this.clubManagerService.getNextMatch(teamId).subscribe(match => {
  console.log('Prochain match:', match);
});

// Enrichir les matchs avec des donn√©es calcul√©es
const enrichedMatches = this.clubManagerService.enrichMatches(matches, teamId);
console.log('Matchs enrichis:', enrichedMatches);

// Filtrer par p√©riode
const thisWeek = this.clubManagerService.filterMatchesByPeriod(enrichedMatches, 'week');
console.log('Matchs de la semaine:', thisWeek);

// Trier les matchs
const sorted = this.clubManagerService.sortMatches(enrichedMatches, 'date_asc');
console.log('Matchs tri√©s:', sorted);
```

### Exemple 6 : R√©cup√©rer toutes les donn√©es d'un club

```typescript
// R√©cup√©rer tous les matchs de toutes les √©quipes
this.clubManagerService.getAllClubMatches(clubId, {
  status: 'planned',
  per_page: 50
}).subscribe(matches => {
  console.log('Tous les matchs du club:', matches);
});

// R√©cup√©rer tous les joueurs de toutes les √©quipes
this.clubManagerService.getAllClubPlayers(clubId).subscribe(players => {
  console.log('Tous les joueurs du club:', players);
});

// R√©cup√©rer tout le staff de toutes les √©quipes
this.clubManagerService.getAllClubStaff(clubId).subscribe(staff => {
  console.log('Tout le staff du club:', staff);
});
```

## üîÑ Flux de donn√©es

### 1. Connexion
```
Utilisateur se connecte
    ‚Üì
AuthService r√©cup√®re les infos (dont club_id)
    ‚Üì
Logs dans la console avec club_id
    ‚Üì
Redirection vers dashboard club manager
```

### 2. Chargement du dashboard
```
Dashboard s'initialise
    ‚Üì
R√©cup√®re club_id de l'utilisateur connect√©
    ‚Üì
Appelle getClubById(club_id)
    ‚Üì
Re√ßoit club avec liste des √©quipes
    ‚Üì
Pour chaque √©quipe, peut charger les d√©tails
```

### 3. Chargement d'une √©quipe
```
S√©lection d'une √©quipe
    ‚Üì
Appelle getTeamWithAllData(team_id)
    ‚Üì
Charge en parall√®le :
  - Infos de l'√©quipe
  - Liste des joueurs
  - Liste du staff
  - Matchs √† venir
  - Matchs pass√©s
    ‚Üì
Affiche toutes les donn√©es
```

## üì° Endpoints API utilis√©s

### Club
- `GET /api/v1/clubs/{clubId}` ‚Üí R√©cup√®re le club et ses √©quipes

### √âquipes
- `GET /api/v1/teams/{teamId}` ‚Üí R√©cup√®re une √©quipe
- `GET /api/v1/teams/{teamId}/players` ‚Üí R√©cup√®re les joueurs
- `GET /api/v1/teams/{teamId}/staffs` ‚Üí R√©cup√®re le staff
- `GET /api/v1/teams/{teamId}/matches` ‚Üí R√©cup√®re les matchs (avec pagination)
- `GET /api/v1/teams/{teamId}/seasons` ‚Üí R√©cup√®re les saisons

### Joueurs
- `GET /api/v1/players/show/{playerId}` ‚Üí R√©cup√®re un joueur

## üé® Fonctionnalit√©s du service

### Cache automatique
Le service utilise un cache de 5 minutes pour √©viter les requ√™tes r√©p√©titives :
```typescript
shareReplay(1, this.CACHE_DURATION) // 5 minutes
```

### Gestion des erreurs
Toutes les m√©thodes incluent une gestion d'erreur avec fallback :
```typescript
catchError((err) => {
  console.error('Erreur:', err);
  return of([]); // Retourne un tableau vide au lieu de planter
})
```

### Logs d√©taill√©s
Le service log toutes les op√©rations importantes pour faciliter le debug :
```typescript
console.log('üè¢ [CLUB MANAGER SERVICE] R√©cup√©ration du club:', clubId);
console.log('‚úÖ [CLUB MANAGER SERVICE] Club re√ßu:', club);
console.log('‚ùå [CLUB MANAGER SERVICE] Erreur:', err);
```

### Chargement parall√®le optimis√©
La m√©thode `getTeamWithAllData()` utilise `forkJoin` pour charger toutes les donn√©es en parall√®le au lieu de s√©quentiellement, ce qui am√©liore consid√©rablement les performances.

## üîê V√©rification des droits

Dans vos composants, v√©rifiez toujours que l'utilisateur est bien un responsable de club :

```typescript
ngOnInit() {
  const user = this.authService.currentUser;
  
  if (!user?.is_club_manager) {
    console.error('Utilisateur non autoris√©');
    this.router.navigate(['/']);
    return;
  }
  
  if (!user.club_id) {
    console.error('Club ID manquant');
    return;
  }
  
  // Continuer le chargement...
}
```

## üìù Conseils d'utilisation

1. **Utilisez les signals Angular** : Pour une r√©activit√© optimale
2. **Pr√©f√©rez `getTeamWithAllData()`** : Pour charger toutes les donn√©es d'une √©quipe en une fois
3. **Utilisez la pagination** : Pour les listes de matchs longues
4. **Enrichissez les matchs** : Utilisez `enrichMatches()` pour avoir plus d'informations
5. **G√©rez les erreurs** : Affichez des messages d'erreur clairs √† l'utilisateur
6. **Utilisez le cache** : Les donn√©es sont cach√©es 5 minutes automatiquement

## üêõ Debug

Les logs sont pr√©fix√©s pour faciliter le debug :
- `üè¢ [CLUB MANAGER SERVICE]` : Op√©rations sur le club
- `‚öΩ [CLUB MANAGER SERVICE]` : Op√©rations sur les √©quipes
- `üë• [CLUB MANAGER SERVICE]` : Op√©rations sur les joueurs
- `üëî [CLUB MANAGER SERVICE]` : Op√©rations sur le staff
- `üìÖ [CLUB MANAGER SERVICE]` : Op√©rations sur les saisons
- `‚úÖ [CLUB MANAGER SERVICE]` : Succ√®s
- `‚ùå [CLUB MANAGER SERVICE]` : Erreurs
- `‚ö†Ô∏è [CLUB MANAGER SERVICE]` : Avertissements

## üéØ Prochaines √©tapes

1. Cr√©er les routes pour les pages du club manager
2. Cr√©er les composants pour afficher les listes (joueurs, staff, matchs)
3. Ajouter les fonctionnalit√©s CRUD si n√©cessaire
4. Impl√©menter les statistiques du club
5. Ajouter des graphiques et visualisations

## üìö Ressources

- Mod√®les : `/src/app/models/club-manager-api.model.ts`
- Service : `/src/app/service/club-manager.service.ts`
- Exemple composant : `/src/app/pages/club-manager-dashboard/`
- AuthService : `/src/app/service/auth.service.ts` (avec logs club_id)

---

**Cr√©√© le :** 2025-10-24  
**Version :** 1.0  
**Auteur :** Cursor AI Assistant
