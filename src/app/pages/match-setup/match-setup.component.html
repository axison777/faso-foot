<p-toast></p-toast>
<div class="match-setup">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <header class="header">
    <h1>Pr√©paration du match</h1>
  </header>

  <p-tabView>
    <!-- Onglet OFFICIELS -->
    <p-tabPanel header="Officiels">
      <div class="card">
        <h3>Assignation des officiels</h3>

        <div class="assignments">
          <div class="assignment-row">

            <!-- Select R√îLE -->
            <div class="field">
              <!-- <label for="role">R√¥le</label> -->
              <p-select inputId="role" [options]="getAvailableRoles()" placeholder="-- Choisir un r√¥le --"
                [(ngModel)]="selectedRole" [disabled]="isClosed || getAvailableRoles().length === 0" name="role">
              </p-select>

              <div class="p-text-secondary" *ngIf="getAvailableRoles().length === 0">
                Tous les r√¥les ont d√©j√† √©t√© assign√©s.
              </div>
            </div>

            <!-- Select OFFICIEL -->
            <div class="field" *ngIf="selectedRole">
              <!-- <label for="official">Officiel</label> -->
              <p-select inputId="official" [options]="getAvailableOfficialsForRole(selectedRole)"
                optionLabel="user.first_name" optionValue="id" placeholder="-- Choisir un officiel --"
                [(ngModel)]="selectedOfficialId"
                [disabled]="isClosed || getAvailableOfficialsForRole(selectedRole).length === 0" name="official"
                filter="true">
                <ng-template let-official pTemplate="item">
                  {{ official.user.first_name }} {{ official.user.last_name }}
                  ({{ getOfficialTypeLabel(official.official_type) }})
                  - {{ getStatusLabel(official.status) }}
                </ng-template>
                <ng-template let-official pTemplate="selectedItem">
                  {{ official.user.first_name }} {{ official.user.last_name }}
                  ({{ getOfficialTypeLabel(official.official_type) }})
                </ng-template>
              </p-select>
            </div>

            <!-- Bouton d'assignation -->
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn btn-info" type="button" (click)="assignOfficial()"
                [disabled]="!selectedOfficialId || !selectedRole || isClosed">
                Assigner
              </button>
            </div>
          </div>

          <!-- Liste des officiels d√©j√† assign√©s -->
          <div class="assigned-officials">
            <h4>Officiels d√©j√† assign√©s</h4>
            <table *ngIf="officialsofmatch.length > 0; else noOfficials" class="custom-table">
              <thead>
                <tr>
                  <th>Nom - Pr√©nom(s)</th>
                  <th>Type d'officiel</th>
                  <th>R√¥le assign√©</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let o of officialsofmatch">
                  <td *ngIf="o.user; else noUser">
                    {{ o.user.first_name }} {{ o.user.last_name }}
                  </td>
                  <ng-template #noUser>
                    <td>Donn√©es utilisateur manquantes</td>
                  </ng-template>
                  <td>{{ getOfficialTypeLabel(o.official_type) }}</td>
                  <td>{{ mapRole(o.matches?.[0]?.pivot?.role ?? '') }}</td>
                </tr>
              </tbody>
            </table>
            <ng-template #noOfficials>
              <p>Aucun officiel assign√© pour l‚Äôinstant.</p>
            </ng-template>
          </div>
        </div>
      </div>
    </p-tabPanel>


    <!-- Onglet TEAMS -->
    <!-- Onglets et autres parties omises si tu les as d√©j√† ‚Äî je fournis uniquement la section TEAMS telle que tu l'as transmise, compl√®te -->
    <p-tabPanel header="√âquipes">
      <div class="teams-callup-container">
        <h2>Feuille de match - Listes des √©quipes</h2>
        <div class="flex justify-between gap-3 mt-4 mb-2">
          <p-button (click)="toggleHomeForm()" icon="pi pi-pencil" label="Composition Domicile" severity="contrast">

          </p-button>

          <p-button (click)="toggleAwayForm()" icon="pi pi-pencil" label="Composition Exterieur" severity="contrast">

          </p-button>
        </div>

        <div class="flex justify-between gap-3 mt-4 mb-2" style="display:flex;gap:8px;">

          <!-- buttons pour ouvrir le composeur de feuille -->
            <button pButton type="button" label="Modifier composition (domicile)" (click)="openPitch('home')"></button>
            <button pButton type="button" label="Modifier composition (ext√©rieur)" (click)="openPitch('away')"></button>

          <!-- PitchSetupComponent -->
          <app-pitch-setup *ngIf="showPitch" [availablePlayersData]="currentAvailablePlayersPayload"
            [coachName]="currentCoachName" [teamName]="currentTeamName" (close)="onPitchClose()"
            (saveSheet)="onReceiveSheet($event)">
          </app-pitch-setup>

        </div>
        <!-- Si aucune donn√©e (assignedTeams) -->
        <div *ngIf="!assignedTeams">
          <p>Aucune donn√©e de composition disponible.</p>
        </div>

        <!-- Si donn√©es pr√©sentes : cards r√©sum√© -->
        <div *ngIf="assignedTeams" class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div *ngIf="assignedTeams.team_one_callup" class="team-card">
            <h3>{{ assignedTeams.team_one_callup.team_name }}</h3>
            <img *ngIf="assignedTeams.team_one_callup.team_logo" [src]="assignedTeams.team_one_callup.team_logo"
              alt="Logo √©quipe" class="team-logo">
            <p><strong>Coach :</strong> {{ assignedTeams.team_one_callup.coach_name || 'Non renseign√©' }}</p>
            <p><strong>Formation :</strong> {{ assignedTeams.team_one_callup.formation }}</p>
            <p><strong>Capitaine :</strong> {{ assignedTeams.team_one_callup.captain_name }}</p>

            <h4>Titulaires</h4>
            <ul>
              <li *ngFor="let p of getStarters(assignedTeams.team_one_callup.players)">
                <img [src]="p.photo || 'assets/images/football-player.png'" alt="Photo" width="32">
                {{ p.first_name }} {{ p.last_name }} ({{ p.position }}) - #{{ p.jersey_number }}
              </li>
            </ul>

            <h4>Rempla√ßants</h4>
            <ul>
              <li *ngFor="let p of getSubstitutes(assignedTeams.team_one_callup.players)">
                <img [src]="p.photo || 'assets/images/football-player.png'" alt="Photo" width="32">
                {{ p.first_name }} {{ p.last_name }} ({{ p.position }}) - #{{ p.jersey_number }}
              </li>
            </ul>
          </div>

          <div *ngIf="assignedTeams.team_two_callup" class="team-card">
            <h3>{{ assignedTeams.team_two_callup.team_name }}</h3>
            <img *ngIf="assignedTeams.team_two_callup.team_logo" [src]="assignedTeams.team_two_callup.team_logo"
              alt="Logo √©quipe" class="team-logo">
            <p><strong>Coach :</strong> {{ assignedTeams.team_two_callup.coach_name || 'Non renseign√©' }}</p>
            <p><strong>Formation :</strong> {{ assignedTeams.team_two_callup.formation }}</p>
            <p><strong>Capitaine :</strong> {{ assignedTeams.team_two_callup.captain_name }}</p>

            <h4>Titulaires</h4>
            <ul>
              <li *ngFor="let p of getStarters(assignedTeams.team_two_callup.players)">
                <img [src]="p.photo || 'assets/images/football-player.png'" alt="Photo" width="32">
                {{ p.first_name }} {{ p.last_name }} ({{ p.position }}) - #{{ p.jersey_number }}
              </li>
            </ul>

            <h4>Rempla√ßants</h4>
            <ul>
              <li *ngFor="let p of getSubstitutes(assignedTeams.team_two_callup.players)">
                <img [src]="p.photo || 'assets/images/football-player.png'" alt="Photo" width="32">
                {{ p.first_name }} {{ p.last_name }} ({{ p.position }}) - #{{ p.jersey_number }}
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Contr√¥les pour ouvrir les formulaires (par √©quipe) -->


      <div class="grid grid-cols-1 gap-6 mt-6 teams md:grid-cols-2">
        <!-- Formulaire √âquipe Domicile (affich√© seulement si on a cliqu√©) -->
        <p-dialog [draggable]="false" [modal]="true" [closable]="false" [(visible)]="showHomeForm"
          [style]="{ width: '1300px', height: '90vw' }" [styleClass]="'team-card'" *ngIf="showHomeForm">
          <h4>√âquipe Domicile</h4>
          <div class="mb-4 team-info">
            <img [src]="homeTeam.logo" alt="Logo domicile" class="team-logo" />
            <span>{{ homeTeam.name }}</span>
          </div>
          <div class="grid grid-cols-1 gap-4 mb-4 meta md:grid-cols-3">
            <div class="flex flex-col field">
              <label for="formation">Formation</label>
              <p-select [options]="formations" [(ngModel)]="homeCallup.formation" [disabled]="isClosed"
                optionLabel="label" optionValue="value" placeholder="-- Choisir formation --"></p-select>
            </div>
            <div class="flex flex-col field">
              <label for="coach">Coach</label>
              <p-select [options]="homeCoaches" [(ngModel)]="homeCallup.coachId" [disabled]="isClosed"
                optionLabel="name" optionValue="id" placeholder="-- Choisir coach --"
                (ngModelChange)="setCoach('home', $event)"></p-select>
            </div>
            <div class="flex flex-col field">
              <label for="captain">Capitaine</label>
              <p-select [options]="homeCallup.players" [(ngModel)]="homeCallup.captainId" [disabled]="isClosed"
                optionLabel="playerName" optionValue="playerId" [filter]="true" placeholder="-- Choisir capitaine --"
                (ngModelChange)="setCaptain('home', $event)">
                <ng-template let-player pTemplate="item">
                  {{ getPlayerName('home', player.playerId) }}
                </ng-template>
                <ng-template let-player pTemplate="selectedItem">
                  {{ getPlayerName('home', player.playerId) }}
                </ng-template>
              </p-select>
            </div>
          </div>
          <h5>Joueurs disponibles</h5>
          <div class="border rounded-md p-4 bg-gray-50 max-h-[370px] overflow-y-auto">
            <div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4">
              <div *ngFor="let p of homePlayersPool"
                class="relative flex flex-col items-center gap-2 p-4 bg-white border rounded-lg shadow-sm" [ngClass]="{
     'ring-yellow-400': getPlayerRingClass(p) === 'yellow',
    ' ring-green-500':getPlayerRingClass(p) === 'green',
    'ring-2':p.selected,
    selected: p.selected
  }" (click)="onPlayerToggle('home', p, !p.selected)" tabindex="0" role="button" [attr.aria-pressed]="p.selected">
                <p-checkbox [binary]="true" [(ngModel)]="p.selected" (ngModelChange)="onPlayerToggle('home', p, $event)"
                  (click)="$event.stopPropagation()" class="absolute top-2 left-2" />
                <div *ngIf="p.selected"
                  class="absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-0.5 rounded-full">
                  #{{ p.selectionOrder }}
                </div>
                <img *ngIf="p.photo_url; else noPhoto" [src]="p.photo_url" alt="Photo joueur"
                  class="object-cover w-12 h-12 rounded-full" />
                <ng-template #noPhoto>
                  <div
                    class="flex items-center justify-center w-12 h-12 text-sm text-gray-500 bg-gray-200 rounded-full">
                    N/A
                  </div>
                </ng-template>
                <div class="text-sm font-semibold text-center">
                  {{ p.first_name }} {{ p.last_name }}
                </div>
                <div class="text-xs text-gray-500 uppercase">
                  {{ p.position }}
                </div>
              </div>
            </div>
          </div>

          <ng-template #footer>
            <div class="flex gap-5 mt-3 justify-content-between align-items-center">
              <div class="p-3 text-sm text-gray-700 border border-gray-300 rounded bg-gray-50">
                <strong>L√©gende :</strong>
                <ul class="mt-2 space-y-1">
                  <li>üü¢ <strong>Vert</strong> ‚Äî Titulaire (dans les 11 premiers s√©lectionn√©s)</li>
                  <li>üü° <strong>Jaune</strong> ‚Äî Rempla√ßant (au-del√† des 11 premiers)</li>
                </ul>
              </div>

              <div class=" pt-[55px]">
                <p-button [raised]="true" label="Sauvegarder Domicile" class="mr-2 p-button-primary"
                  (click)="saveCallup('home')" [disabled]="isClosed"></p-button>
                <p-button [raised]="true" label="Annuler" severity="secondary" (click)="toggleHomeForm()"></p-button>
              </div>
            </div>
          </ng-template>
        </p-dialog>







        <!-- Formulaire √âquipe Ext√©rieure (affich√© seulement si on a cliqu√©) -->
        <p-dialog [draggable]="false" [modal]="true" [closable]="false" [(visible)]="showAwayForm"
          [style]="{ width: '1300px', height: '90vw' }" [styleClass]="'team-card'" *ngIf="showAwayForm">
          <h4>√âquipe Ext√©rieure</h4>

          <div class="mb-4 team-info">
            <img [src]="awayTeam.logo" alt="Logo ext√©rieur" class="team-logo" />
            <span>{{ awayTeam.name }}</span>
          </div>

          <div class="grid grid-cols-1 gap-4 mb-4 meta md:grid-cols-3">
            <div class="flex flex-col field">
              <label for="formation">Formation</label>
              <p-select [options]="formations" [(ngModel)]="awayCallup.formation" [disabled]="isClosed"
                optionLabel="label" optionValue="value" placeholder="-- Choisir formation --"></p-select>
            </div>
            <div class="flex flex-col field">
              <label for="coach">Coach</label>
              <p-select [options]="awayCoaches" [(ngModel)]="awayCallup.coachId" [disabled]="isClosed"
                optionLabel="name" optionValue="id" placeholder="-- Choisir coach --"
                (ngModelChange)="setCoach('away', $event)"></p-select>
            </div>
            <div class="flex flex-col field">
              <label for="captain">Capitaine</label>
              <p-select [options]="awayCallup.players" [(ngModel)]="awayCallup.captainId" [disabled]="isClosed"
                optionLabel="playerName" optionValue="playerId" [filter]="true" placeholder="-- Choisir capitaine --"
                (ngModelChange)="setCaptain('away', $event)">
                <ng-template let-player pTemplate="item">
                  {{ getPlayerName('away', player.playerId) }}
                </ng-template>
                <ng-template let-player pTemplate="selectedItem">
                  {{ getPlayerName('away', player.playerId) }}
                </ng-template>
              </p-select>
            </div>
          </div>

          <h5>Joueurs disponibles</h5>
          <div class="border rounded-md p-4 bg-gray-50 max-h-[370px] overflow-y-auto">
            <div class="grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4">
              <div *ngFor="let p of awayPlayersPool"
                class="relative flex flex-col items-center gap-2 p-4 bg-white border rounded-lg shadow-sm" [ngClass]="{
     'ring-yellow-400': getPlayerRingClass(p) === 'yellow',
    ' ring-green-500':getPlayerRingClass(p) === 'green',
    'ring-2':p.selected,
    selected: p.selected
  }" (click)="onPlayerToggle('away', p, !p.selected)" tabindex="0" role="button" [attr.aria-pressed]="p.selected">

                <p-checkbox [binary]="true" [(ngModel)]="p.selected" (ngModelChange)="onPlayerToggle('away', p, $event)"
                  (click)="$event.stopPropagation()" class="absolute top-2 left-2" />

                <div *ngIf="p.selected"
                  class="absolute top-2 right-2 bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">
                  #{{ p.selectionOrder }}
                </div>

                <img *ngIf="p.photo_url; else noPhotoAway" [src]="p.photo_url" alt="Photo joueur"
                  class="object-cover w-12 h-12 rounded-full" />
                <ng-template #noPhotoAway>
                  <div
                    class="flex items-center justify-center w-12 h-12 text-sm text-gray-500 bg-gray-200 rounded-full">
                    N/A</div>
                </ng-template>

                <div class="text-sm font-semibold text-center">{{ p.first_name }} {{ p.last_name }}</div>
                <div class="text-xs text-gray-500 uppercase">{{ p.position }}</div>
              </div>
            </div>
          </div>

          <ng-template #footer>
            <div class="flex gap-5 mt-3 justify-content-between align-items-center">
              <div class="p-3 text-sm text-gray-700 border border-gray-300 rounded bg-gray-50">
                <strong>L√©gende :</strong>
                <ul class="mt-2 space-y-1">
                  <li>üü¢ <strong>Vert</strong> ‚Äî Titulaire (dans les 11 premiers s√©lectionn√©s)</li>
                  <li>üü° <strong>Jaune</strong> ‚Äî Rempla√ßant (au-del√† des 11 premiers)</li>
                </ul>
              </div>

              <div class=" pt-[55px]">
                <p-button [raised]="true" label="Sauvegarder Ext√©rieur" class="mr-2 p-button-primary"
                  (click)="saveCallup('away')" [disabled]="isClosed"></p-button>
                <p-button [raised]="true" label="Annuler" severity="secondary" (click)="toggleAwayForm()"></p-button>
              </div>
            </div>
          </ng-template>
        </p-dialog>
      </div>
    </p-tabPanel>


  </p-tabView>

</div>
