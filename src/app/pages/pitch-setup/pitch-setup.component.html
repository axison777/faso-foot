<!-- Nouvelle interface de composition des matchs -->
<div class="composition-backdrop">
  <div class="composition-container">
    
    <!-- En-tête de la Page -->
    <header class="composition-header">
      <div class="header-content">
        <h1 class="page-title">Match à Venir</h1>
        <button class="close-btn" (click)="closePanel()" type="button">
          <i class="pi pi-times"></i>
        </button>
      </div>
      
      <!-- Navigation par Onglets -->
      <nav class="tab-navigation">
        <button class="tab-btn" [class.active]="activeTab === 'callup'" (click)="setActiveTab('callup')">
          Appel des Joueurs
        </button>
        <button class="tab-btn active" [class.active]="activeTab === 'composition'" (click)="setActiveTab('composition')">
          Modifier Composition
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'sheet'" (click)="setActiveTab('sheet')">
          Feuille de Match
        </button>
      </nav>
    </header>

    <!-- Contenu Principal -->
    <div class="composition-content">
      
      <!-- Panneau Principal de Composition (Côté Gauche) -->
      <main class="main-panel">
        
        <!-- Sélecteur de Formation -->
        <section class="formation-selector">
          <div class="formation-controls">
            <div class="formation-dropdown">
              <label for="formation-select">Formation</label>
              <select 
                id="formation-select" 
                [(ngModel)]="team.formationKey" 
                (change)="applyFormation(team.formationKey)"
                class="formation-select"
              >
                <option *ngFor="let k of formationKeys" [value]="k">{{ formations[k].name }}</option>
              </select>
              <button class="info-btn" type="button" title="Informations sur les formations">
                <i class="pi pi-info-circle"></i>
              </button>
            </div>
            
            <!-- Aperçu rapide des formations -->
            <div class="formation-preview">
              <button 
                *ngFor="let formation of getPopularFormations()" 
                class="formation-preview-btn"
                [class.active]="team.formationKey === formation.key"
                (click)="applyFormation(formation.key)"
                type="button"
              >
                <div class="formation-diagram">
                  <div class="formation-name">{{ formation.key }}</div>
                  <div class="formation-dots">
                    <div *ngFor="let line of formation.lines" class="formation-line">
                      <span *ngFor="let dot of getDots(line)" class="formation-dot"></span>
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </section>

        <!-- Terrain de Football -->
        <section class="pitch-section">
          <div class="pitch-container" #pitchContainer>
            <div class="football-pitch">
              <!-- SVG du terrain -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80" class="pitch-svg">
                <defs>
                  <pattern id="grass-pattern" patternUnits="userSpaceOnUse" width="8" height="80">
                    <rect width="4" height="80" fill="#2d5a3d"></rect>
                    <rect x="4" width="4" height="80" fill="#1e4a32"></rect>
                  </pattern>
                </defs>
                
                <!-- Fond du terrain -->
                <rect width="120" height="80" fill="url(#grass-pattern)"></rect>
                
                <!-- Lignes du terrain -->
                <g fill="none" stroke="#ffffff" stroke-width="0.8">
                  <!-- Contour du terrain -->
                  <rect x="2" y="2" width="116" height="76" rx="2"></rect>
                  
                  <!-- Ligne médiane -->
                  <line x1="60" y1="2" x2="60" y2="78"></line>
                  
                  <!-- Cercle central -->
                  <circle cx="60" cy="40" r="12" fill="none"></circle>
                  <circle cx="60" cy="40" r="1" fill="#ffffff"></circle>
                  
                  <!-- Surface de réparation gauche -->
                  <rect x="2" y="20" width="18" height="40"></rect>
                  <rect x="2" y="30" width="6" height="20"></rect>
                  <circle cx="14" cy="40" r="1" fill="#ffffff"></circle>
                  
                  <!-- Surface de réparation droite -->
                  <rect x="100" y="20" width="18" height="40"></rect>
                  <rect x="112" y="30" width="6" height="20"></rect>
                  <circle cx="106" cy="40" r="1" fill="#ffffff"></circle>
                  
                  <!-- Arcs de cercle des surfaces -->
                  <path d="M 20 25 A 12 12 0 0 1 20 55" fill="none"></path>
                  <path d="M 100 25 A 12 12 0 0 0 100 55" fill="none"></path>
                </g>
              </svg>

              <!-- Placement des joueurs sur le terrain -->
              <div 
                *ngFor="let pos of team.positions; let i = index" 
                class="player-position"
                [style.left.%]="pos.x"
                [style.top.%]="pos.y"
                (click)="openPlayerSelector(i)"
                cdkDropList
                [cdkDropListData]="[pos]"
                (cdkDropListDropped)="onPlayerDropped($event, i)"
              >
                <div 
                  *ngIf="getPlayer(pos.playerId) as player; else emptyPosition"
                  class="player-avatar"
                  cdkDrag
                  [cdkDragData]="player"
                >
                  <img 
                    [src]="player.photoUrl || 'assets/images/football-player.png'" 
                    [alt]="getPlayerName(player)"
                    (error)="onPhotoError($event)"
                    class="player-photo"
                  >
                  <div class="player-number">{{ player.jersey_number || player.number || '?' }}</div>
                  <div class="player-name">{{ getShortName(player) }}</div>
                </div>
                
                <ng-template #emptyPosition>
                  <div class="empty-position">
                    <div class="position-role">{{ pos.role }}</div>
                    <i class="pi pi-plus"></i>
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </section>

      </main>

      <!-- Panneau des Joueurs (Côté Droit) -->
      <aside class="players-panel">
        
        <!-- Bouton d'Action Principal -->
        <div class="action-section">
          <button 
            class="primary-action-btn"
            [disabled]="!canFinalize()"
            (click)="save()"
            type="button"
          >
            <i class="pi pi-check"></i>
            SAUVEGARDER & PARTAGER AVEC OFFICIELS
          </button>
        </div>

        <!-- Liste des Joueurs Disponibles -->
        <section class="available-players">
          <h3 class="section-title">
            <i class="pi pi-users"></i>
            Liste des Joueurs
          </h3>
          
          <div class="players-list" cdkDropList [cdkDropListData]="unselected" (cdkDropListDropped)="onPlayerListDrop($event)">
            <div 
              *ngFor="let player of unselected" 
              class="player-card"
              cdkDrag
              [cdkDragData]="player"
            >
              <img 
                [src]="player.photoUrl || 'assets/images/football-player.png'" 
                [alt]="getPlayerName(player)"
                (error)="onPhotoError($event)"
                class="player-avatar-small"
              >
              <div class="player-info">
                <div class="player-name-bold">{{ getPlayerName(player) }}</div>
                <div class="player-status">
                  <span class="status-indicator status-present"></span>
                  Présent
                </div>
              </div>
              <div class="player-actions">
                <button 
                  class="action-btn starter-btn" 
                  (click)="pickAsStarter(player.id)"
                  title="Ajouter comme titulaire"
                  type="button"
                >
                  <i class="pi pi-arrow-up"></i>
                </button>
                <button 
                  class="action-btn substitute-btn" 
                  (click)="addAsSubstitute(player.id)"
                  title="Ajouter comme remplaçant"
                  type="button"
                >
                  <i class="pi pi-arrow-down"></i>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Section des Remplaçants -->
        <section class="substitutes-section">
          <h3 class="section-title">
            <i class="pi pi-users"></i>
            Remplaçants Choisis
            <span class="count-badge">{{ substitutes.length }}</span>
          </h3>
          
          <div class="substitutes-container" cdkDropList [cdkDropListData]="substitutes" (cdkDropListDropped)="onSubstitutesDrop($event)">
            <div 
              *ngFor="let player of substitutes; let i = index" 
              class="substitute-card"
              cdkDrag
              [cdkDragData]="player"
            >
              <div class="substitute-order">{{ i + 1 }}</div>
              <img 
                [src]="player.photoUrl || 'assets/images/football-player.png'" 
                [alt]="getPlayerName(player)"
                (error)="onPhotoError($event)"
                class="substitute-avatar"
              >
              <div class="substitute-info">
                <div class="substitute-name">{{ getPlayerName(player) }}</div>
                <div class="substitute-position">{{ player.position || 'Milieu' }}</div>
              </div>
              <button 
                class="remove-btn" 
                (click)="removeFromSubstitutes(player.id)"
                title="Retirer du banc"
                type="button"
              >
                <i class="pi pi-times"></i>
              </button>
            </div>
            
            <!-- Zone de dépôt pour ajouter des remplaçants -->
            <div class="drop-zone" *ngIf="substitutes.length < 7">
              <i class="pi pi-plus"></i>
              <span>Glisser un joueur ici</span>
            </div>
          </div>
        </section>

        <!-- Informations sur la composition -->
        <section class="composition-info">
          <div class="info-item">
            <span class="info-label">Formation :</span>
            <span class="info-value">{{ team.formationKey || 'Non définie' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Titulaires :</span>
            <span class="info-value">{{ getStartersCount() }}/11</span>
          </div>
          <div class="info-item">
            <span class="info-label">Remplaçants :</span>
            <span class="info-value">{{ substitutes.length }}/7</span>
          </div>
          <div class="info-item">
            <span class="info-label">Capitaine :</span>
            <select 
              [(ngModel)]="team.captainId" 
              class="captain-select"
            >
              <option [ngValue]="null">Choisir un capitaine</option>
              <option *ngFor="let player of starters" [value]="player.id">
                {{ getPlayerName(player) }}
              </option>
            </select>
          </div>
        </section>

      </aside>

    </div>

    <!-- Sélecteur de joueur modal -->
    <div class="player-selector-modal" *ngIf="selectedPositionIndex !== null" (click)="closePlayerSelector()">
      <div class="selector-content" (click)="$event.stopPropagation()">
        <h4>Assigner un joueur - {{ selectedRoleLabel() }}</h4>
        <div class="selector-players">
          <div 
            *ngFor="let player of roster" 
            class="selector-player"
            (click)="assignPlayerToPosition(player.id)"
          >
            <img 
              [src]="player.photoUrl || 'assets/images/football-player.png'" 
              [alt]="getPlayerName(player)"
              (error)="onPhotoError($event)"
            >
            <div class="selector-player-info">
              <div class="selector-player-name">{{ getPlayerName(player) }}</div>
              <div class="selector-player-number">#{{ player.jersey_number || player.number || '?' }}</div>
            </div>
          </div>
        </div>
        <button class="selector-close" (click)="closePlayerSelector()" type="button">
          Fermer
        </button>
      </div>
    </div>

  </div>
</div>