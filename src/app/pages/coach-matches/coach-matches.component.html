<div class="coach-matches-page">
  <div class="page-header">
    <h1>Calendrier des Matchs</h1>
    <p>Gérez et consultez tous les matchs de votre équipe</p>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Chargement des matchs...</p>
    </div>
  }

  @if (error()) {
    <div class="error-state">
      <i class="pi pi-exclamation-triangle"></i>
      <p>{{ error() }}</p>
      <button pButton label="Réessayer" (click)="loadMatches()" class="p-button-primary"></button>
    </div>
  }

  @if (!loading() && !error()) {
    <!-- Filtres -->
    <div class="filters-section">
      <p-card>
        <div class="filters-grid">
          <div class="filter-item search-wide">
            <label>Rechercher un adversaire</label>
            <span class="p-input-icon-left" style="width: 100%;">
              <i class="pi pi-search"></i>
              <input 
                type="text" 
                pInputText 
                [(ngModel)]="searchOpponent" 
                (input)="onSearchChange()"
                placeholder="Nom de l'équipe adverse..."
                style="width: 100%;" />
            </span>
          </div>

          <div class="filter-item">
            <label>Statut</label>
            <p-dropdown 
              [options]="statusOptions" 
              [(ngModel)]="selectedStatus" 
              (onChange)="onStatusChange()"
              optionLabel="label" 
              optionValue="value"
              placeholder="Statut">
            </p-dropdown>
          </div>

          <div class="filter-item">
            <label>Période</label>
            <p-dropdown 
              [options]="periodOptions" 
              [(ngModel)]="selectedPeriod" 
              (onChange)="onPeriodChange()"
              optionLabel="label" 
              optionValue="value"
              placeholder="Période">
            </p-dropdown>
          </div>

          <div class="filter-item">
            <label>Saison</label>
            <p-dropdown 
              [options]="seasons()" 
              [(ngModel)]="selectedSeason" 
              (onChange)="onSeasonChange()"
              optionLabel="label" 
              placeholder="Toutes les saisons"
              [showClear]="true">
            </p-dropdown>
          </div>

          <div class="filter-item">
            <label>Compétition</label>
            <p-dropdown 
              [options]="competitions()" 
              [(ngModel)]="selectedCompetition" 
              (onChange)="onCompetitionChange()"
              optionLabel="name" 
              placeholder="Toutes les compétitions"
              [showClear]="true">
            </p-dropdown>
          </div>

          <div class="filter-item">
            <label>Trier par</label>
            <p-dropdown 
              [options]="sortOptions" 
              [(ngModel)]="sortBy" 
              (onChange)="onSortChange()"
              optionLabel="label" 
              optionValue="value">
            </p-dropdown>
          </div>

          <div class="filter-actions">
            <button 
              pButton 
              label="Réinitialiser" 
              icon="pi pi-filter-slash" 
              class="p-button-secondary"
              (click)="resetFilters()">
            </button>
            <button 
              pButton 
              label="Actualiser" 
              icon="pi pi-refresh" 
              class="p-button-success"
              (click)="refreshMatches()">
            </button>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Liste des matchs -->
    <div class="matches-list-section">
      <h2><i class="pi pi-list"></i> Tous les Matchs ({{ filteredMatches().length }})</h2>
      
      @if (filteredMatches().length === 0) {
        <div class="empty-state">
          <i class="pi pi-calendar-times"></i>
          <h3>Aucun match trouvé</h3>
          <p>Il n'y a aucun match correspondant à vos critères.</p>
        </div>
      } @else {
        <div class="matches-grid">
          @for (match of filteredMatches(); track match.id) {
            <p-card class="match-card" [class.past]="isPast(match)" [class.upcoming]="isUpcoming(match)">
              <div class="match-card-content">
                <div class="match-header">
                  <div class="match-date">
                    <span class="date">{{ match.matchDate | date:'dd/MM/yyyy' }}</span>
                    <span class="time">{{ match.matchDate | date:'HH:mm' }}</span>
                  </div>
                  <div class="match-status-badge" [class.upcoming]="isUpcoming(match)">
                    {{ getMatchStatus(match) }}
                  </div>
                </div>

                <div class="teams-compact">
                  <div class="team-row" [class.my-team]="match.isMyTeamHome">
                    <img [src]="match.team_one?.logo || 'assets/default-team.png'" 
                         [alt]="match.team_one?.name" class="team-logo-sm" />
                    <span class="team-name">{{ match.team_one?.abbreviation || match.team_one?.name }}</span>
                    @if (match.isMyTeamHome) {
                      <span class="badge-my-team">Mon Équipe</span>
                    }
                  </div>

                  <div class="team-row" [class.my-team]="!match.isMyTeamHome">
                    <img [src]="match.team_two?.logo || 'assets/default-team.png'" 
                         [alt]="match.team_two?.name" class="team-logo-sm" />
                    <span class="team-name">{{ match.team_two?.abbreviation || match.team_two?.name }}</span>
                    @if (!match.isMyTeamHome) {
                      <span class="badge-my-team">Mon Équipe</span>
                    }
                  </div>
                </div>

                <div class="match-info-compact">
                  <div class="info-row">
                    <i class="pi pi-map-marker"></i>
                    <span>{{ match.stadium?.name || 'Stade' }}</span>
                  </div>
                  <div class="info-row">
                    <i class="pi pi-trophy"></i>
                    <span>{{ match.pool?.name || 'Compétition' }} - J{{ match.match_day?.number || '?' }}</span>
                  </div>
                  @if (match.is_derby === 1) {
                    <div class="info-row derby">
                      <i class="pi pi-star-fill"></i>
                      <span>Derby</span>
                    </div>
                  }
                  @if (match.is_rescheduled === 1) {
                    <div class="info-row rescheduled">
                      <i class="pi pi-calendar-plus"></i>
                      <span>Reporté</span>
                    </div>
                  }
                </div>

                <button 
                  pButton 
                  label="Détails" 
                  icon="pi pi-arrow-right" 
                  class="p-button-text p-button-sm"
                  (click)="openMatchDetails(match)">
                </button>
              </div>
            </p-card>
          }
        </div>
      }
    </div>
  }

  <!-- Modal des détails -->
  <p-dialog 
    [(visible)]="showDetailsModal" 
    [modal]="true" 
    [style]="{ width: '800px' }"
    [draggable]="false"
    [resizable]="false"
    header="Détails du Match">
    
    @if (selectedMatch(); as match) {
      <div class="match-details-modal">
        <div class="modal-header">
          <div class="match-teams">
            <div class="team-detail home">
              <img [src]="match.team_one?.logo || 'assets/default-team.png'" 
                   [alt]="match.team_one?.name" />
              <div class="team-text">
                <h3>{{ match.team_one?.name }}</h3>
                <span class="badge">{{ match.isMyTeamHome ? 'Mon Équipe' : 'Adversaire' }}</span>
              </div>
            </div>

            <div class="vs-modal">
              <span>VS</span>
              <div class="match-datetime">
                <div class="date">{{ match.matchDate | date:'EEEE d MMMM y':'':'fr' }}</div>
                <div class="time">{{ match.matchDate | date:'HH:mm' }}</div>
              </div>
            </div>

            <div class="team-detail away">
              <div class="team-text">
                <h3>{{ match.team_two?.name }}</h3>
                <span class="badge">{{ !match.isMyTeamHome ? 'Mon Équipe' : 'Adversaire' }}</span>
              </div>
              <img [src]="match.team_two?.logo || 'assets/default-team.png'" 
                   [alt]="match.team_two?.name" />
            </div>
          </div>
        </div>

        <div class="modal-body">
          <div class="info-section">
            <h4><i class="pi pi-info-circle"></i> Informations Générales</h4>
            <div class="info-grid">
              <div class="info-item">
                <label>Compétition</label>
                <span>{{ match.pool?.name || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Journée</label>
                <span>{{ match.match_day?.number || 'N/A' }} ({{ match.match_day?.leg || 'N/A' }})</span>
              </div>
              <div class="info-item">
                <label>Stade</label>
                <span>{{ match.stadium?.name || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Date et Heure</label>
                <span>{{ match.matchDate | date:'dd/MM/yyyy à HH:mm' }}</span>
              </div>
              @if (match.is_derby === 1) {
                <div class="info-item derby-badge">
                  <i class="pi pi-star-fill"></i>
                  <span>Match Derby</span>
                </div>
              }
              @if (match.is_rescheduled === 1) {
                <div class="info-item rescheduled-badge">
                  <i class="pi pi-calendar-plus"></i>
                  <span>Match Reporté</span>
                </div>
              }
            </div>
          </div>

          <div class="info-section">
            <h4><i class="pi pi-flag"></i> Équipes</h4>
            <div class="teams-detail-grid">
              <div class="team-card">
                <img [src]="match.team_one?.logo || 'assets/default-team.png'" 
                     [alt]="match.team_one?.name" />
                <h5>{{ match.team_one?.name }}</h5>
                <p>{{ match.team_one?.abbreviation }}</p>
                @if (match.isMyTeamHome) {
                  <span class="my-team-badge">Mon Équipe (Domicile)</span>
                }
              </div>
              <div class="team-card">
                <img [src]="match.team_two?.logo || 'assets/default-team.png'" 
                     [alt]="match.team_two?.name" />
                <h5>{{ match.team_two?.name }}</h5>
                <p>{{ match.team_two?.abbreviation }}</p>
                @if (!match.isMyTeamHome) {
                  <span class="my-team-badge">Mon Équipe (Extérieur)</span>
                }
              </div>
            </div>
          </div>

          @if (match.season) {
            <div class="info-section">
              <h4><i class="pi pi-calendar"></i> Saison</h4>
              <div class="season-info">
                <p><strong>Début :</strong> {{ match.season.start_date | date:'dd/MM/yyyy' }}</p>
                <p><strong>Fin :</strong> {{ match.season.end_date | date:'dd/MM/yyyy' }}</p>
              </div>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button 
            pButton 
            label="Fermer" 
            icon="pi pi-times" 
            class="p-button-secondary"
            (click)="closeDetailsModal()">
          </button>
        </div>
      </div>
    }
  </p-dialog>

  <p-toast></p-toast>
</div>
