<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>

<div class="officials-container">
    <!-- Header -->
    <div class="header">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
            rel="stylesheet" />
        <h1>Gestion des Officiels</h1>
        <div class="header-actions">
            <button class="btn btn-info" (click)="toggleForm()">
                <i class="pi pi-plus-circle mr-2"></i>Ajouter un officiel
            </button>
        </div>
    </div>

    <!-- Onglets -->
    <p-tabView [(activeIndex)]="activeIndex" class="officials-tabs">
        <!-- TAB ARBITRES -->
        <p-tabPanel header="Arbitres" leftIcon="pi pi-flag">
            <!-- Search -->
            <div class="search-container flex align-items-end">
                <input type="text" class="search-input" [(ngModel)]="searchTerm"
                    placeholder="Rechercher un arbitre (nom, pr√©nom, licence)..." />
            </div>

            <!-- Loading -->
            <div *ngIf="loading" class="loading">Chargement des arbitres...</div>

            <!-- Table -->
            <div *ngIf="!loading && referees.length > 0" class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <!-- <th>N¬∞ Licence</th> -->
                            <th>Niveau</th>
                            <th>Structure</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let o of referees; let i = index">
                            <td>{{ i + 1 }}</td>
                            <!-- Ancien mod√®le -->
                            <!-- <td class="cell-strong">{{ o.last_name }}</td> -->
                            <!-- <td>{{ o?.first_name }}</td> -->
                            <!-- Nouveau mod√®le -->
                            <td class="cell-strong">{{ o?.user?.last_name }}</td>
                            <td>{{ o?.user?.first_name }}</td>

                            <!-- <td>{{ o.license_number }}</td> -->
                            <td>{{ o.level }}</td>
                            <td>{{ o.structure || '‚Äî' }}</td>
                            <td>
                                <span class="badge" [ngClass]="{
                                    'status-active': o.status === 'ACTIVE',
                                    'status-suspended': o.status === 'SUSPENDED',
                                    'status-retired': o.status === 'RETIRED'
                                }">
                                    {{ o.status }}
                                </span>
                            </td>
                            <td class="actions">
                                <div class="btn-group">
                                    <p-button severity="warn" icon="pi pi-pencil" (click)="editOfficial(o)" />
                                    <button class="btn btn-info" (click)="viewOfficialDetails(o)">
                                        <i class="pi pi-eye"></i>
                                    </button>
                                    <button class="btn btn-danger" (click)="deleteOfficial(o.id!)">
                                        <i class="pi pi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- No results -->
            <div *ngIf="!loading && referees.length === 0 && searchTerm" class="no-results">
                <div class="icon">üîç</div>
                <p>Aucun arbitre trouv√© pour "{{ searchTerm }}"</p>
            </div>
        </p-tabPanel>

        <!-- TAB COMMISSAIRES -->
        <p-tabPanel header="Commissaires" leftIcon="pi pi-briefcase">
            <!-- Search -->
            <div class="search-container flex align-items-end">
                <input type="text" class="search-input" [(ngModel)]="searchTerm"
                    placeholder="Rechercher un commissaire (nom, pr√©nom, licence)..." />
            </div>

            <!-- Loading -->
            <div *ngIf="loading" class="loading">Chargement des commissaires...</div>

            <!-- Table -->
            <div *ngIf="!loading && commissioners.length > 0" class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>N¬∞ Licence</th>
                            <th>Niveau</th>
                            <th>Structure</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let o of commissioners; let i = index">
                            <td>{{ i + 1 }}</td>
                            <!-- Ancien mod√®le -->
                            <!-- <td class="cell-strong">{{ o.last_name }}</td> -->
                            <!-- <td>{{ o?.first_name }}</td> -->
                            <!-- Nouveau mod√®le -->
                            <td class="cell-strong">{{ o?.user?.last_name }}</td>
                            <td>{{ o?.user?.first_name }}</td>
                            <td>{{ o.license_number }}</td>
                            <td>{{ o.level }}</td>
                            <td>{{ o.structure || '‚Äî' }}</td>
                            <td>
                                <span class="badge" [ngClass]="{
                                    'status-active': o.status === 'ACTIVE',
                                    'status-suspended': o.status === 'SUSPENDED',
                                    'status-retired': o.status === 'RETIRED'
                                }">
                                    {{ o.status }}
                                </span>
                            </td>
                            <td class="actions">
                                <div class="btn-group">
                                    <p-button severity="warn" icon="pi pi-pencil" (click)="editOfficial(o)" />
                                    <button class="btn btn-info" (click)="viewOfficialDetails(o)">
                                        <i class="pi pi-eye"></i>
                                    </button>
                                    <button class="btn btn-danger" (click)="deleteOfficial(o.id!)">
                                        <i class="pi pi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- No results -->
            <div *ngIf="!loading && commissioners.length === 0 && searchTerm" class="no-results">
                <div class="icon">üîç</div>
                <p>Aucun commissaire trouv√© pour "{{ searchTerm }}"</p>
            </div>
        </p-tabPanel>
    </p-tabView>

    <!-- ========== DIALOG FORM CREATE / EDIT ========== -->
    <p-dialog [(visible)]="showForm" [modal]="true" [draggable]="false" [closable]="false" [style]="{ width: '800px' }"
        [header]="isEditing ? 'Modifier un officiel' : 'Ajouter un officiel'">
        <form [formGroup]="officialForm" class="form-grid" (ngSubmit)="saveOfficial()">

            <!-- NOM -->
            <div class="form-item">
                <label>Nom <span class="req">*</span></label>
                <!-- Ancien -->
                <!-- <input pInputText formControlName="last_name" placeholder="Nom" /> -->
                <!-- Nouveau -->
                <input pInputText formControlName="user_last_name" placeholder="Nom" />
                <small class="error"
                    *ngIf="officialForm.get('user_last_name')?.invalid && officialForm.get('user_last_name')?.touched">
                    Le nom est requis
                </small>
            </div>

            <!-- PR√âNOM -->
            <div class="form-item">
                <label>Pr√©nom <span class="req">*</span></label>
                <!-- Ancien -->
                <!-- <input pInputText formControlName="first_name" placeholder="Pr√©nom" /> -->
                <!-- Nouveau -->
                <input pInputText formControlName="user_first_name" placeholder="Pr√©nom" />
                <small class="error"
                    *ngIf="officialForm.get('user_first_name')?.invalid && officialForm.get('user_first_name')?.touched">
                    Le pr√©nom est requis
                </small>
            </div>

             <!-- DATE DE NAISSANCE -->
            <div class="form-item">
                <label>Date de naissance</label>
                <p-datepicker [style]="{ width: '100%' }" formControlName="date_of_birth" dateFormat="dd/mm/yy"
                    [showIcon]="true"></p-datepicker>
            </div>

            <!-- LIEU DE NAISSANCE -->
            <div class="form-item">
                <label>Lieu de naissance</label>
                <input pInputText formControlName="birth_place" placeholder="Lieu" />
            </div>

            <!-- Email -->
            <div class="form-item">
                <label>Adresse email <span class="req">*</span></label>
                <!-- Ancien -->
                <!-- <input pInputText formControlName="email" type="email" placeholder="email" /> -->
                <!-- Nouveau -->
                <input pInputText formControlName="user_email" type="email" placeholder="email" />
                <small class="error"
                    *ngIf="officialForm.get('user_email')?.touched && officialForm.get('user_email')?.invalid">
                    <ng-container *ngIf="officialForm.get('user_email')?.errors?.['required']">
                        Une adresse mail est requise.
                    </ng-container>
                    <ng-container *ngIf="officialForm.get('user_email')?.errors?.['email']">
                        L'adresse email n'est pas valide.
                    </ng-container>
                </small>
            </div>

            <!-- TYPE -->
            <div class="form-item">
                <label>Type <span class="req">*</span></label>
                <p-select [options]="officialTypes" formControlName="official_type" optionLabel="label"
                    optionValue="value" placeholder="Type d'officiel"></p-select>
            </div>

            <!-- NIVEAU -->
            <div class="form-item">
                <label>Niveau <span class="req">*</span></label>
                <p-select [options]="levels" formControlName="level" optionLabel="label" optionValue="value"
                    placeholder="Niveau"></p-select>
            </div>

            <!-- STATUT -->
            <div class="form-item">
                <label>Statut <span class="req">*</span></label>
                <p-select [options]="statuses" formControlName="status" optionLabel="label" optionValue="value"
                    placeholder="Statut"></p-select>
            <small class="error" *ngIf="officialForm.get('status')?.invalid && officialForm.get('status')?.touched">
                    Le statut est requis
                </small>
            </div>

            <!-- NATIONALIT√â -->
            <div class="form-item">
                <label>Nationalit√©</label>
                <input pInputText formControlName="nationality" placeholder="Nationalit√©" />
            </div>

            <!-- LICENCE -->
            <div class="form-item">
                <label>N¬∞ Licence <span class="req">*</span></label>
                <input pInputText formControlName="license_number" placeholder="Licence" />
            </div>

            <!-- STRUCTURE -->
            <div class="form-item">
                <label>Structure</label>
                <input pInputText formControlName="structure" placeholder="Structure" />
            </div>

            <!-- EXP√âRIENCE -->
            <div class="form-item">
                <label>Exp√©rience (ann√©es)</label>
                <input pInputText formControlName="experience" type="number" />
            </div>

            <!-- CERTIFICATION DATE -->
            <div class="form-item">
                <label>Date de certification</label>
                <p-datepicker [style]="{ width: '100%' }" formControlName="certification_date" dateFormat="dd/mm/yy"
                    [showIcon]="true"></p-datepicker>
            </div>

            <!-- CERTIFICATION EXPIRY -->
            <div class="form-item">
                <label>Expiration de certification</label>
                <p-datepicker [style]="{ width: '100%' }" formControlName="certification_expiry" dateFormat="dd/mm/yy"
                    [showIcon]="true"></p-datepicker>
            </div>

            <!-- FOOTER -->
            <div class="form-footer">
                <p-button [raised]="true" severity="secondary" type="button" (click)="toggleForm()">Annuler</p-button>
                <p-button [loading]="loadingForm" [raised]="true" type="submit">Enregistrer</p-button>
            </div>
        </form>
    </p-dialog>
</div>
